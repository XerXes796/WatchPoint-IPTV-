name: Update Custom IPTV Playlist

on:
  schedule:
    - cron: '0 * * * *' # every hour
  workflow_dispatch:

permissions:
  contents: write   # allows pushing back

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Fetch Drew's raw playlist
        run: |
          curl -s https://raw.githubusercontent.com/Drewski2423/DrewLive/main/MergedCleanPlaylist.m3u8 -o full.m3u8

      - name: Backup old playlist
        run: |
          cp "Watch-point IPTV.m3u8" "Watch-point IPTV.backup.$(date +'%Y%m%d%H%M%S').m3u8"

      - name: Filter selected channels
        run: |
          # Extract only URLs from your clean playlist
          grep -o 'http.*' "Watch-point IPTV.m3u8" > urls.txt

          # Filter Drew's master playlist to keep only these URLs
          grep -F -f urls.txt full.m3u8 > "Watch-point IPTV.m3u8"

      - name: Commit & push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add "Watch-point IPTV.m3u8"
          git commit -m "Auto-update playlist" || echo "No changes"
          git push
